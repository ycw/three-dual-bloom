<!doctype html>

<head>
  <meta charset="utf8">
  <link rel="icon" href="data:,">
  <title>Dual Bloom</title>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      display: grid;
      place-content: center;
      height: 100vh;
      background: linear-gradient(darkred, darkblue);
    }

    h1 {
      font-size: 25vh;
    }

    canvas {
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      display: block;
      width: 100%;
      height: 100vh;
      cursor: grab;
    }

    #tp {
      position: fixed;
      z-index: 2;
      right: 1rem;
      top: 1rem;
    }
  </style>
  <script type="module" defer>
    import * as THREE from '//cdn.skypack.dev/three@0.128.0?min';
    import { OrbitControls } from '//cdn.skypack.dev/three@0.128.0/examples/jsm/controls/OrbitControls?min'
    import { EffectComposer, Pass, FullScreenQuad } from '//cdn.skypack.dev/three@0.128.0/examples/jsm/postprocessing/EffectComposer?min'
    import { RenderPass } from '//cdn.skypack.dev/three@0.128.0/examples/jsm/postprocessing/RenderPass?min'
    import { DualBloomPassGen } from '../src/index.js'
    import Tweakpane from '//cdn.skypack.dev/tweakpane';
    import { WEBGL } from '//cdn.skypack.dev/three@0.128.0/examples/jsm/WebGL.js';

    // ---- probe

    if (!WEBGL.isWebGL2Available()) {
      throw alert(WEBGL.getWebGL2ErrorMessage());
    }

    // ---- params 

    const params = {
      threshold: .5,
      blurriness: .5,
      intensity: 2,
    };

    // ---- renderer

    const renderer = new THREE.WebGLRenderer({ alpha: true });
    renderer.setSize(innerWidth, innerHeight, false);
    renderer.setPixelRatio(devicePixelRatio);

    const canvas = renderer.domElement;
    document.body.append(canvas);

    // ---- camera and controls

    const camera = new THREE.PerspectiveCamera(50, 2, .1, 100);
    const controls = new OrbitControls(camera, canvas);
    camera.position.set(0, 0, 3);
    controls.enableDamping = true;

    // ---- build scene

    const scene = new THREE.Scene();

    scene.add(new THREE.DirectionalLight());
    scene.add(new THREE.AmbientLight());

    const mesh = new THREE.Mesh(
      new THREE.TorusKnotBufferGeometry(1, .2, 12, 16),
      new THREE.MeshNormalMaterial()
    );
    mesh.rotation.x = Math.PI / -3;
    scene.add(mesh);

    // ---- effect composer

    const DualBloomPass = DualBloomPassGen({ THREE, Pass, FullScreenQuad });
    const dualBloomPass = new DualBloomPass({ 
      maxDuals: 8,
      blurriness: params.blurriness,
      intensity: params.intensity,
      threshold: params.threshold
    });

    const fx = new EffectComposer(renderer);
    fx.addPass(new RenderPass(scene, camera));
    fx.addPass(dualBloomPass);

    // ---- gui
    const tweakpane = new Tweakpane({ title: 'Bloom', container: document.querySelector('#tp') });
    tweakpane.addInput(params, 'threshold', { min: 0, max: 1 });
    tweakpane.addInput(params, 'blurriness', { min: 0, max: 1 });
    tweakpane.addInput(params, 'intensity', { min: 0, max: 4 });
    tweakpane.on('change', () => {
      dualBloomPass.threshold = params.threshold;
      dualBloomPass.blurriness = params.blurriness;
      dualBloomPass.intensity = params.intensity;
    });

    // ----- render loop

    renderer.setAnimationLoop((t) => {
      controls.update();
      fx.render();
    });

    // ----- on resize

    window.addEventListener('resize', () => {
      renderer.setSize(innerWidth, innerHeight, false);
      renderer.setPixelRatio(devicePixelRatio);
      fx.setSize(innerWidth, innerHeight);
      fx.setPixelRatio(devicePixelRatio);
      camera.aspect = canvas.width / canvas.height;
      camera.updateProjectionMatrix();
    });
    dispatchEvent(new Event('resize'));
  </script>
</head>

<body>
  <h1>Dual Bloom</h1>
  <div id='tp'></div>
</body>